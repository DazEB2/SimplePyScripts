<html>
<head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
    <title>js__mini_played_games_parser</title>
    <script type="text/javascript" src="static/js/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="static/js/parser.js"></script>
    <style>
        body {
            padding: 1rem;
            font-size: 16px;
        }
        textarea {
            overflow: scroll;
            white-space: pre;
            width: 100%;
            min-height: 30rem;
            font-family: "Lucida Console", Monaco, monospace;
            font-size: 0.8rem;
            line-height: 1.2;
        }
    </style>
</head>
<body>
    <table>
        <tr><td><div id="url_file_gist"></div></td></tr>
        <tr>
            <td style="vertical-align: top;"><textarea readonly="readonly" id="result_raw" cols="100" rows="10"></textarea></td>
            <td style="vertical-align: top;"><textarea readonly="readonly" id="result_json" cols="100" rows="10"></textarea></td>
        </tr>
    </table>

    <script>
        function process_error(jqXHR, textStatus, errorThrown) {
            console.log("error: " + jqXHR + ", " + textStatus + ", " + errorThrown);
            $('#result_raw').text("<error>");
            alert("error: " + jqXHR + ", " + textStatus + ", " + errorThrown);
        }

        // Для обхода: "Запрос из постороннего источника заблокирован: Политика одного источника запрещает чтение удаленного ресурса"
        $.ajaxPrefilter( function (options) {
            if (options.crossDomain && jQuery.support.cors) {
                var http = (window.location.protocol === 'http:' ? 'http:' : 'https:');
                options.url = http + '//cors-anywhere.herokuapp.com/' + options.url;
                //options.url = "http://cors.corsproxy.io/url=" + options.url;
            }
        });

        const url_gist = "https://gist.github.com/gil9red/2f80a34fb601cd685353";

        $(document).ready(function() {
            $.get(url_gist, function(response) {
                console.log("success");

                let match = response.match(new RegExp("/gil9red/2f80a34fb601cd685353/raw/.+/gistfile1.txt"));
                if (match == null) {
                    alert("No match url_file_gist!");
                    return;
                }
                let url_file_gist = new URL(match[0], url_gist).href;
                console.log(url_file_gist);
                $('#url_file_gist').text(url_file_gist);

                $.get(url_file_gist, function(response) {
                    console.log("success");
                    // console.log(response);

                    $('#result_raw').text(response);

                    let platforms = parse_played_games(response);
                    $('#result_json').text(
                        stringifyMap(platforms)
                    );

                }).fail(process_error);

            }).fail(process_error);
        });
    </script>

</body>
</html>